// routes/masterAdmin.js - Secure Master Admin Routes v15.0
'use strict';

const express = require('express');
const crypto = require('crypto');
const router = express.Router();

const { firebase, FB_KEY } = require('../config/database');
const { 
    // Password utilities
    verifyPassword, 
    hashPassword,
    validatePasswordStrength,
    // Brute force protection
    isIPBlocked, 
    getBlockedRemainingTime,
    recordLoginAttempt, 
    getRemainingAttempts,
    // Session management
    createSession, 
    destroySession,
    // Middleware
    authAdmin,
    // Stats
    getAuthStats
} = require('../middleware/auth');
const { getInstance: getSecurityInstance } = require('../middleware/security');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ› ï¸ HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const getClientIP = (req) => {
    return req.clientIP || 
           req.headers['cf-connecting-ip'] ||
           req.headers['x-real-ip'] ||
           req.headers['x-forwarded-for']?.split(',')[0].trim() ||
           req.ip || 'unknown';
};

const formatDate = (timestamp) => {
    if (!timestamp) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const date = new Date(timestamp);
    return date.toLocaleString('ar-SA');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ” SECURE LOGIN - No Default Credentials!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/login', async (req, res) => {
    const ip = getClientIP(req);
    const userAgent = req.headers['user-agent'] || 'unknown';
    
    try {
        // 1. Check if IP is blocked
        if (isIPBlocked(ip)) {
            const remaining = getBlockedRemainingTime(ip);
            console.log(`ðŸš« Blocked IP attempted login: ${ip}`);
            return res.status(429).json({
                success: false,
                error: `ØªÙ… Ø­Ø¸Ø± IP Ù…Ø¤Ù‚ØªØ§Ù‹. Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ ${remaining} Ø¯Ù‚ÙŠÙ‚Ø©`,
                code: 'IP_BLOCKED',
                retryAfter: remaining * 60
            });
        }
        
        const { username, password, deviceFingerprint } = req.body;
        
        // 2. Validate input
        if (!username || !password) {
            return res.status(400).json({
                success: false,
                error: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†',
                code: 'MISSING_CREDENTIALS'
            });
        }
        
        // 3. Add random delay (prevents timing attacks)
        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 500));
        
        // 4. Get credentials from environment ONLY
        const MASTER_USERNAME = process.env.MASTER_ADMIN_USERNAME;
        const MASTER_PASSWORD_HASH = process.env.MASTER_ADMIN_PASSWORD_HASH;
        
        // 5. Check if credentials are configured
        if (!MASTER_USERNAME || !MASTER_PASSWORD_HASH) {
            console.error('ðŸš¨ CRITICAL: Master Admin credentials not configured!');
            return res.status(500).json({
                success: false,
                error: 'Ø®Ø·Ø£ ÙÙŠ ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø®Ø§Ø¯Ù…',
                code: 'SERVER_CONFIG_ERROR'
            });
        }
        
        console.log(`ðŸ” Login attempt: ${username} from IP: ${ip}`);
        
        // 6. Verify username (timing-safe comparison)
        const usernameBuffer = Buffer.from(username.padEnd(100));
        const expectedBuffer = Buffer.from(MASTER_USERNAME.padEnd(100));
        const usernameValid = crypto.timingSafeEqual(usernameBuffer, expectedBuffer);
        
        // 7. Verify password with bcrypt
        const passwordValid = verifyPassword(password, MASTER_PASSWORD_HASH);
        
        // 8. Both must be valid
        if (!usernameValid || !passwordValid) {
            recordLoginAttempt(ip, false);
            const remaining = getRemainingAttempts(ip);
            
            console.log(`âŒ Login failed: ${username} | Remaining attempts: ${remaining}`);
            
            // Record in security system
            const security = getSecurityInstance();
            if (security) security.recordLoginAttempt(ip, false);
            
            return res.status(401).json({
                success: false,
                error: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
                code: 'INVALID_CREDENTIALS',
                remainingAttempts: remaining
            });
        }
        
        // 9. Success! Record and create secure session
        recordLoginAttempt(ip, true);
        
        const security = getSecurityInstance();
        if (security) security.recordLoginAttempt(ip, true);
        
        const sessionData = createSession(
            'master_admin',
            'master',
            ip,
            userAgent,
            deviceFingerprint
        );
        
        // 10. Log successful login
        console.log('â•'.repeat(50));
        console.log(`âœ… MASTER ADMIN LOGIN SUCCESSFUL`);
        console.log(`   User: ${username}`);
        console.log(`   IP: ${ip}`);
        console.log(`   Session: ${sessionData.sessionId.substring(0, 16)}...`);
        console.log('â•'.repeat(50));
        
        return res.json({
            success: true,
            message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­',
            sessionId: sessionData.sessionId,
            sessionToken: sessionData.token,
            expiresAt: sessionData.expiresAt,
            expiresIn: sessionData.expiresIn,
            user: {
                username: username,
                type: 'master'
            }
        });
        
    } catch (error) {
        console.error('Login error:', error.message);
        res.status(500).json({ 
            success: false, 
            error: 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
            code: 'LOGIN_ERROR'
        });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸšª LOGOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/logout', authAdmin, (req, res) => {
    const sessionId = req.sessionId;
    
    if (sessionId) {
        destroySession(sessionId);
        console.log(`ðŸ‘‹ Master Admin logged out`);
    }
    
    res.json({ 
        success: true, 
        message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­' 
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœ… VERIFY SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.get('/verify-session', authAdmin, (req, res) => {
    const session = req.session;
    
    res.json({
        success: true,
        valid: true,
        session: {
            userId: session.userId,
            userType: session.userType,
            createdAt: session.createdAt,
            expiresAt: session.expiresAt,
            remainingTime: Math.floor((session.expiresAt - Date.now()) / 1000 / 60) + ' Ø¯Ù‚ÙŠÙ‚Ø©'
        }
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”„ REFRESH SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/refresh-session', authAdmin, (req, res) => {
    const ip = getClientIP(req);
    const userAgent = req.headers['user-agent'];
    const { deviceFingerprint } = req.body;
    
    // Destroy old session
    destroySession(req.sessionId);
    
    // Create new session
    const newSession = createSession(
        req.session.userId,
        'master',
        ip,
        userAgent,
        deviceFingerprint
    );
    
    res.json({
        success: true,
        message: 'ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©',
        sessionId: newSession.sessionId,
        sessionToken: newSession.token,
        expiresAt: newSession.expiresAt
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ” CHANGE PASSWORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/change-password', authAdmin, async (req, res) => {
    try {
        const { currentPassword, newPassword, confirmPassword } = req.body;
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            return res.status(400).json({
                success: false,
                error: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©'
            });
        }
        
        if (newPassword !== confirmPassword) {
            return res.status(400).json({
                success: false,
                error: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©'
            });
        }
        
        // Validate password strength
        const validation = validatePasswordStrength(newPassword);
        if (!validation.valid) {
            return res.status(400).json({
                success: false,
                error: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©',
                requirements: validation.errors
            });
        }
        
        // Verify current password
        const currentHash = process.env.MASTER_ADMIN_PASSWORD_HASH;
        if (!verifyPassword(currentPassword, currentHash)) {
            return res.status(401).json({
                success: false,
                error: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©'
            });
        }
        
        // Generate new hash
        const newHash = hashPassword(newPassword);
        
        console.log('ðŸ” Password change requested - New hash generated');
        
        res.json({
            success: true,
            message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
            newHash: newHash,
            instruction: 'Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« MASTER_ADMIN_PASSWORD_HASH ÙÙŠ Ù…Ù„Ù .env Ø«Ù… Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…'
        });
        
    } catch (error) {
        console.error('Change password error:', error.message);
        res.status(500).json({ success: false, error: 'Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“Š SECURITY & AUTH STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.get('/security-stats', authAdmin, (req, res) => {
    const security = getSecurityInstance();
    const authStats = getAuthStats();
    
    res.json({ 
        success: true, 
        stats: {
            auth: authStats,
            security: security ? security.getStats() : { message: 'Security system not initialized' }
        }
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ‘¥ GET ALL USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.get('/users', authAdmin, async (req, res) => {
    try {
        const response = await firebase.get(`users.json?auth=${FB_KEY}`);
        const users = response.data || {};

        const formattedUsers = {};
        for (const [id, user] of Object.entries(users)) {
            const subEnd = user.subscription_end || 0;
            formattedUsers[id] = {
                username: user.username || '',
                is_active: user.is_active !== false,
                expiry_timestamp: subEnd,
                expiry_date: formatDate(subEnd),
                created_at: user.created_at || null,
                last_login: user.last_login || null,
                device_id: user.device_id || '',
                device_info: user.device_model ? `${user.device_brand || ''} ${user.device_model}` : '',
                login_count: user.login_count || 0,
                max_devices: user.max_devices || 1,
                created_by_key: user.created_by_key || 'master'
            };
        }

        res.json({ success: true, data: formattedUsers, count: Object.keys(formattedUsers).length });
    } catch (error) {
        console.error('Get users error:', error.message);
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âž• CREATE USER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/users', authAdmin, async (req, res) => {
    try {
        const { username, password, expiryMinutes, customExpiryDate, maxDevices, status } = req.body;

        if (!username || !password) {
            return res.status(400).json({ success: false, error: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†' });
        }

        // Check duplicate
        const checkUrl = `users.json?orderBy="username"&equalTo="${encodeURIComponent(username)}"&auth=${FB_KEY}`;
        const checkRes = await firebase.get(checkUrl);

        if (checkRes.data && Object.keys(checkRes.data).length > 0) {
            return res.status(400).json({ success: false, error: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„' });
        }

        let expiryTimestamp;
        if (customExpiryDate) {
            expiryTimestamp = new Date(customExpiryDate).getTime();
        } else if (expiryMinutes && expiryMinutes > 0) {
            expiryTimestamp = Date.now() + (expiryMinutes * 60 * 1000);
        } else {
            return res.status(400).json({ success: false, error: 'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ' });
        }

        const userData = {
            username,
            password_hash: hashPassword(password),
            is_active: status !== 'inactive',
            subscription_end: expiryTimestamp,
            max_devices: maxDevices || 1,
            device_id: '',
            created_at: Date.now(),
            created_by: req.session?.userId || 'master'
        };

        const createRes = await firebase.post(`users.json?auth=${FB_KEY}`, userData);
        
        console.log(`âœ… User created: ${username} by master admin`);
        
        res.json({ 
            success: true, 
            message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 
            userId: createRes.data.name,
            expiryDate: formatDate(expiryTimestamp)
        });
    } catch (error) {
        console.error('Create user error:', error.message);
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœï¸ UPDATE USER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.patch('/users/:id', authAdmin, async (req, res) => {
    try {
        const { is_active, max_devices, notes } = req.body;
        const updateData = {};

        if (typeof is_active === 'boolean') updateData.is_active = is_active;
        if (max_devices) updateData.max_devices = max_devices;
        if (notes !== undefined) updateData.notes = notes;

        await firebase.patch(`users/${req.params.id}.json?auth=${FB_KEY}`, updateData);
        res.json({ success: true, message: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­' });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ—‘ï¸ DELETE USER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.delete('/users/:id', authAdmin, async (req, res) => {
    try {
        await firebase.delete(`users/${req.params.id}.json?auth=${FB_KEY}`);
        console.log(`ðŸ—‘ï¸ User deleted: ${req.params.id}`);
        res.json({ success: true, message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­' });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â° EXTEND SUBSCRIPTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/users/:id/extend', authAdmin, async (req, res) => {
    try {
        const { minutes, days, hours } = req.body;
        const userRes = await firebase.get(`users/${req.params.id}.json?auth=${FB_KEY}`);

        if (!userRes.data) {
            return res.status(404).json({ success: false, error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
        }

        const now = Date.now();
        const currentEnd = userRes.data.subscription_end || now;

        let extensionMs = 0;
        if (minutes) extensionMs = minutes * 60 * 1000;
        else if (days || hours) extensionMs = ((days || 0) * 86400000) + ((hours || 0) * 3600000);

        if (!extensionMs) {
            return res.status(400).json({ success: false, error: 'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„ØªÙ…Ø¯ÙŠØ¯' });
        }

        const newEndDate = (currentEnd > now ? currentEnd : now) + extensionMs;

        await firebase.patch(`users/${req.params.id}.json?auth=${FB_KEY}`, {
            subscription_end: newEndDate,
            is_active: true
        });

        res.json({ success: true, message: 'ØªÙ… ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', new_end_date: newEndDate });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”„ RESET DEVICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/users/:id/reset-device', authAdmin, async (req, res) => {
    try {
        await firebase.patch(`users/${req.params.id}.json?auth=${FB_KEY}`, { device_id: '' });
        res.json({ success: true, message: 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø²' });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø²' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ—‘ï¸ DELETE EXPIRED USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/users/delete-expired', authAdmin, async (req, res) => {
    try {
        const response = await firebase.get(`users.json?auth=${FB_KEY}`);
        const users = response.data || {};
        const now = Date.now();
        const deletePromises = [];
        const deletedUsers = [];

        for (const [id, user] of Object.entries(users)) {
            if (user.subscription_end && user.subscription_end <= now) {
                deletePromises.push(firebase.delete(`users/${id}.json?auth=${FB_KEY}`));
                deletedUsers.push(user.username || id);
            }
        }

        if (deletePromises.length === 0) {
            return res.json({ success: true, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ©', count: 0 });
        }

        await Promise.all(deletePromises);
        console.log(`ðŸ—‘ï¸ Deleted ${deletedUsers.length} expired users`);

        res.json({ success: true, message: `ØªÙ… Ø­Ø°Ù ${deletedUsers.length} Ø­Ø³Ø§Ø¨ Ù…Ù†ØªÙ‡ÙŠ`, count: deletedUsers.length });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â¸ï¸ BULK DISABLE EXPIRED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/users/bulk-disable-expired', authAdmin, async (req, res) => {
    try {
        const response = await firebase.get(`users.json?auth=${FB_KEY}`);
        const users = response.data || {};
        const now = Date.now();
        const updatePromises = [];

        for (const [id, user] of Object.entries(users)) {
            if (user.subscription_end && user.subscription_end <= now && user.is_active !== false) {
                updatePromises.push(firebase.patch(`users/${id}.json?auth=${FB_KEY}`, { is_active: false }));
            }
        }

        if (updatePromises.length === 0) {
            return res.json({ success: true, message: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù†ØªÙ‡ÙŠÙŠÙ† Ù†Ø´Ø·ÙŠÙ†', count: 0 });
        }

        await Promise.all(updatePromises);
        res.json({ success: true, message: `ØªÙ… ØªØ¹Ø·ÙŠÙ„ ${updatePromises.length} Ù…Ø³ØªØ®Ø¯Ù…`, count: updatePromises.length });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ—‘ï¸ DELETE INACTIVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.post('/users/delete-inactive', authAdmin, async (req, res) => {
    try {
        const response = await firebase.get(`users.json?auth=${FB_KEY}`);
        const users = response.data || {};
        const deletePromises = [];

        for (const [id, user] of Object.entries(users)) {
            if (user.is_active === false) {
                deletePromises.push(firebase.delete(`users/${id}.json?auth=${FB_KEY}`));
            }
        }

        if (deletePromises.length === 0) {
            return res.json({ success: true, message: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹Ø·Ù„ÙŠÙ†', count: 0 });
        }

        await Promise.all(deletePromises);
        res.json({ success: true, message: `ØªÙ… Ø­Ø°Ù ${deletePromises.length} Ù…Ø³ØªØ®Ø¯Ù…`, count: deletePromises.length });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”‘ API KEYS MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
router.get('/api-keys', authAdmin, async (req, res) => {
    try {
        const response = await firebase.get(`api_keys.json?auth=${FB_KEY}`);
        const keys = response.data || {};

        const formattedKeys = {};
        for (const [id, key] of Object.entries(keys)) {
            formattedKeys[id] = {
                api_key: key.api_key || '',
                admin_name: key.admin_name || '',
                permission_level: key.permission_level || 'view_only',
                is_active: key.is_active !== false,
                expiry_timestamp: key.expiry_timestamp || null,
                usage_count: key.usage_count || 0,
                created_at: key.created_at || null,
                last_used: key.last_used || null
            };
        }

        res.json({ success: true, data: formattedKeys, count: Object.keys(formattedKeys).length });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙØ§ØªÙŠØ­' });
    }
});

router.post('/api-keys', authAdmin, async (req, res) => {
    try {
        const { adminName, permissionLevel, expiryDays } = req.body;

        if (!adminName) {
            return res.status(400).json({ success: false, error: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù Ù…Ø·Ù„ÙˆØ¨' });
        }

        const apiKey = `AK_${crypto.randomBytes(16).toString('hex')}`;
        const signingSecret = `SS_${crypto.randomBytes(32).toString('hex')}`;

        const keyData = {
            api_key: apiKey,
            admin_name: adminName,
            permission_level: permissionLevel || 'view_only',
            is_active: true,
            expiry_timestamp: expiryDays ? Date.now() + (expiryDays * 86400000) : null,
            created_at: Date.now(),
            signing_secret: signingSecret,
            created_by: req.session?.userId || 'master'
        };

        await firebase.post(`api_keys.json?auth=${FB_KEY}`, keyData);
        console.log(`ðŸ”‘ API Key created for: ${adminName}`);

        res.json({
            success: true,
            message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ù†Ø¬Ø§Ø­',
            apiKey,
            signingSecret,
            warning: 'Ø§Ø­ÙØ¸ signing secret ÙÙˆØ±Ø§Ù‹ - Ù„Ù† ÙŠØ¸Ù‡Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!'
        });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙØªØ§Ø­' });
    }
});

router.patch('/api-keys/:id', authAdmin, async (req, res) => {
    try {
        const { is_active } = req.body;
        await firebase.patch(`api_keys/${req.params.id}.json?auth=${FB_KEY}`, { is_active });
        res.json({ success: true, message: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØªØ§Ø­' });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØªØ§Ø­' });
    }
});

router.delete('/api-keys/:id', authAdmin, async (req, res) => {
    try {
        await firebase.delete(`api_keys/${req.params.id}.json?auth=${FB_KEY}`);
        res.json({ success: true, message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙØªØ§Ø­' });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙØªØ§Ø­' });
    }
});

router.post('/api-keys/delete-expired', authAdmin, async (req, res) => {
    try {
        const response = await firebase.get(`api_keys.json?auth=${FB_KEY}`);
        const keys = response.data || {};
        const now = Date.now();
        const deletePromises = [];

        for (const [id, key] of Object.entries(keys)) {
            if (key.expiry_timestamp && key.expiry_timestamp <= now) {
                deletePromises.push(firebase.delete(`api_keys/${id}.json?auth=${FB_KEY}`));
            }
        }

        if (deletePromises.length === 0) {
            return res.json({ success: true, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ§ØªÙŠØ­ Ù…Ù†ØªÙ‡ÙŠØ©', count: 0 });
        }

        await Promise.all(deletePromises);
        res.json({ success: true, message: `ØªÙ… Ø­Ø°Ù ${deletePromises.length} Ù…ÙØªØ§Ø­`, count: deletePromises.length });
    } catch (error) {
        res.status(500).json({ success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­' });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“¦ EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
module.exports = router;
